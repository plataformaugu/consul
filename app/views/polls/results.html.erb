<% provide :title do %><%= @poll.name %><% end %>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<%= render "shared/section_header", i18n_namespace: "polls.index.section_header", image: "polls" %>
<div class="polls-results-stats">
  <%= render "poll_header" %>

  <%= render "poll_subnav" %>

  <div class="row margin" data-equalizer data-equalize-on="medium">
    <div class="small-12 medium-3 column sidebar" data-equalizer-watch>
      <p><strong><%= t("polls.show.results.title") %></strong></p>
      <ul class="menu vertical">
        <%- @poll.questions.each do |question| %>
          <li><%= link_to question.title, "##{question.title.parameterize}" %></li>
        <% end %>
      </ul>
    </div>

    <div class="small-12 medium-9 column" data-equalizer-watch>
      <%- @poll.questions.each do |question| %>
        <% most_voted_answer_id = question.most_voted_answer_id %>
        <h3 id="<%= question.title.parameterize %>"><%= question.title %></h3>
        <table id="question_<%= question.id %>_results_table">
          <thead>
            <tr>
              <%- question.question_answers.each do |answer| %>
                <th scope="col" <%= answer.id == most_voted_answer_id ? "class=win" : "" %>>
                  <% if answer.id == most_voted_answer_id %>
                    <span class="show-for-sr"><%= t("polls.show.results.most_voted_answer") %></span>
                  <% end %>
                  <%= answer.title %>
                </th>
              <% end %>
            </tr>
          </thead>
          <tbody>
            <tr>
              <%- question.question_answers.each do |answer| %>
                <td id="answer_<%= answer.id %>_result" <%= answer.id == most_voted_answer_id ? "class=win" : "" %>>
                  <%= answer.total_votes %>
                  (<%= answer.total_votes_percentage.round(2) %>%)
                </td>
              <% end %>
            </tr>
          </tbody>
        </table>
        <div style="width: 100%; display: flex; justify-content: center;">
          <div style="width: 250px;">
            <canvas id="chart-<%= question.id %>"></canvas>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<% if current_page?(results_poll_path) %>
  <%= javascript_tag do %>
    function drawGraphic(id, labels, votes) {
      var graphicData = {
        labels: labels,
        datasets: [{
          label: 'Pie Chart',
          data: votes,
          backgroundColor: [
            'rgb(255, 99, 132)',
            'rgb(54, 162, 235)',
            'rgb(255, 205, 86)'
          ],
          hoverOffset: 4
        }]
      }

      var graphicConfig = {
        type: 'pie',
        data: graphicData
      }

      var chart = new Chart(
        document.getElementById('chart-' + id),
        graphicConfig
      )
    }
    <% @poll.questions.each do |question| %>
      drawGraphic(<%= question.id %>, <%= raw(question.question_answers.map {|answer| answer.title }) %>, <%= raw(question.question_answers.map {|answer| answer.total_votes }) %>);
    <% end %>
  <% end %>
<% end %>