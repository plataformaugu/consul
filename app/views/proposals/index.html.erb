<% provide :title do %><%= t("proposals.index.title") %><% end %>
<% content_for :header_addon do %>
  <%= render "shared/search_form",
             search_path: proposals_path(page: 1),
             i18n_namespace: "proposals.index.search_form" %>
<% end %>
<% content_for :canonical do %>
  <%= render "shared/canonical", href: proposals_url %>
<% end %>

<main>
  <% if [
          @search_terms,
          @advanced_search_terms,
          params[:retired].present?,
          params[:selected].present?
        ].any? %>
    <%= render Shared::SearchResultsSummaryComponent.new(
      results: @proposals,
      search_terms: @search_terms,
      advanced_search_terms: @advanced_search_terms
    ) do %>
      <% if params[:retired].present? %>
        <h2><%= t("proposals.index.retired_proposals") %></h2>
      <% elsif params[:selected].present? %>
        <h2><%= t("proposals.index.selected_proposals") %></h2>
      <% end %>
    <% end %>
  <% else %>
    <div class="help-header">
      <div class="row">
        <div class="small-12 column" data-magellan>
          <%= image_tag "help/help_icon_proposals.png", alt: t("proposals.index.section_header.icon_alt"), class: "align-top" %>
          <h1 class="inline-block">Propuestas</h1>
          <h4><%= @proposal_topic.title %></h4>
          <small>
            Fecha de inicio: <strong><%= @proposal_topic.start_date %></strong>
            <span class="bullet">&nbsp;&bull;&nbsp;</span>
            Fecha de termino: <strong><%= @proposal_topic.end_date %></strong>
          </small>
        </div>
      </div>
    </div>
  <% end %>

  <% if show_recommended_proposals? %>
    <%= render "shared/recommended_index", recommended: @recommended_proposals,
                                           disable_recommendations_path: recommendations_disable_proposals_path,
                                           namespace: "proposals" %>
  <% end %>

  <div class="row">
    <div id="proposals" class="proposals-list small-12 medium-9 column">

      <%= render Shared::BannerComponent.new("proposals") %>

      <% if show_featured_proposals? and true == false %>
        <div id="featured-proposals" class="row featured-proposals">
          <div class="small-12 column">
            <h2>
              <%= t("proposals.index.featured_proposals") %>
            </h2>
          </div>
          <% @featured_proposals.each do |featured_proposal| %>
            <%= render "featured_proposal", proposal: featured_proposal %>
          <% end %>
        </div>
      <% end %>

      <% unless params[:selected].present? %>
        <div class="row">
          <div class="small-12 column">
            <%= render "view_mode" %>
          </div>
        </div>
      <% end %>

      <% unless params[:retired].present? || params[:selected].present? %>
        <%= render Shared::AdvancedSearchComponent.new %>
      <% end %>

      <% unless params[:selected].present? %>
        <%= render "shared/order_links", i18n_namespace: "proposals.index" %>
      <% end %>

      <% if @proposals.any? %>
        <div class="show-for-small-only">
          <%= link_to t("proposals.index.start_proposal"),
                      new_proposal_path,
                      class: "button expanded" %>
        </div>
      <% end %>

      <div id="proposals-list">
        <% if @proposals.any? || current_user.blank? %>
          <div class="cards-container-component">
            <% @proposals.each do |proposal| %>
              <%= render Shared::CardComponent.new(
                proposal,
                proposal.title,
                proposal.image.variant(:medium),
                '',
                proposal.in_development ? 'Propuesta en desarrollo' : proposal.proposal_topic.is_expired? ? 'Convocatoria finalizada' : nil
              ) %>
            <% end %>
          </div>
        <% else %>
          <%= empty_recommended_proposals_message_text(current_user) %>
        <% end %>
        <%= paginate @proposals %>
      </div>
    </div>

    <div class="small-12 medium-3 column">
      <aside class="margin-bottom">
        <% if @proposal_topic.is_active? %>
          <%= link_to t("proposals.index.start_proposal"),
                      new_proposal_path(proposal_topic_id: @proposal_topic.id),
                      class: "button expanded" %>
        <% else %>
          <div class="callout warning">
            Convocatoria finalizada.
          </div>
        <% end %>

        <% if params[:retired].blank? %>
          <%= render "shared/tag_cloud", taggable: "Proposal" %>
        <% end %>
      </aside>
    </div>

  </div>
</main>
